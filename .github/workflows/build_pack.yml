name: Build and Package

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: List all files
      run: |
        Write-Host "ğŸ“ Repository files:"
        Get-ChildItem -Recurse -File | Select-Object Name, Length

    - name: Check for executable
      run: |
        $exeFiles = Get-ChildItem -Filter "*.exe" -File
        if ($exeFiles) {
          Write-Host "âœ… Found executable files:"
          $exeFiles | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)" }
        } else {
          Write-Host "âš ï¸ No exe files found in repository"
          exit 1
        }

    - name: Create distribution package
      run: |
        New-Item -ItemType Directory -Force -Path "dist"

        # å¤åˆ¶ä¸»ç¨‹åº
        $mainExe = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" -File
        $mainAhk = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.ahk" -File

        if ($mainExe) { Copy-Item $mainExe -Destination "dist/"; Write-Host "âœ… Copied exe" }
        if ($mainAhk) { Copy-Item $mainAhk -Destination "dist/"; Write-Host "âœ… Copied ahk" }

        Copy-Item "config.example.json" -Destination "dist/"
        Copy-Item "README.md" -Destination "dist/"

        New-Item -ItemType Directory -Force -Path "dist\lib" | Out-Null
        Copy-Item -Path "lib\*.ahk" -Destination "dist\lib\" -Force

        if (Test-Path "lib\dll_64") {
          $targetDir = "dist\lib\dll_64"
          if (-not (Test-Path $targetDir)) {
            New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          }
          # Robocopy ä¿®å¤ï¼šå³ä½¿æˆåŠŸå¤åˆ¶(Code 1)ï¼Œä¹Ÿæ‰‹åŠ¨é‡ç½®é€€å‡ºç ä¸º0
          robocopy "lib\dll_64" $targetDir /E /NFL /NDL /NJH /NJS
          if ($LASTEXITCODE -le 7) {
            Write-Host "âœ… Copied dll_64 directory (Robocopy Code: $LASTEXITCODE)"
            $global:LASTEXITCODE = 0  # <---ã€å…³é”®ä¿®å¤ã€‘å¼ºåˆ¶é‡ç½®é€€å‡ºç 
          } else {
            Write-Host "âš ï¸ Robocopy failed with code $LASTEXITCODE"
            exit 1
          }
        }

        Write-Host "ğŸ“¦ Package contents:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Create ZIP archive
      run: |
        # ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ 7z æ›¿ä»£ Compress-Archive ä»¥æ›´å¥½æ”¯æŒä¸­æ–‡æ–‡ä»¶å
        # a: add, -tzip: zip format, -mx9: max compression
        7z a -tzip "Real-time-translation-typing.zip" ".\dist\*" -mx9
        
        Write-Host "ğŸ“¦ Archive created:"
        Get-Item "Real-time-translation-typing.zip" | Select-Object Name, Length

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing
        path: dist/

    # ä¸Šä¼  Zipï¼Œæ³¨æ„è¿™é‡Œ artifact name ä¸åŒ…å« 'zip' åç¼€ï¼Œæ–¹ä¾¿ release æ­¥éª¤ç»Ÿä¸€å¤„ç†
    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-pkg
        path: Real-time-translation-typing.zip

  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-pkg  # å¯¹åº”ä¸Šé¢ä¸Šä¼ çš„ artifact åå­—

    - name: Display Downloaded Files
      run: ls -R # è°ƒè¯•æ­¥éª¤ï¼šæŸ¥çœ‹ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶ç»“æ„

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        # ä½¿ç”¨é€šé…ç¬¦åŒ¹é…ï¼Œé˜²æ­¢å›  download-artifact äº§ç”Ÿæ–‡ä»¶å¤¹å±‚çº§å¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶
        files: |
          **/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}