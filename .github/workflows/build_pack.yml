name: Build and Package

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  release:
    types: [created]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install AutoHotkey
      run: |
        # ä¸‹è½½ AutoHotkey v2.0
        curl -L -o AHK-Installer.exe "https://www.autohotkey.com/download/ahk-install.exe"
        # é™é»˜å®‰è£…
        Start-Process -Wait -FilePath "AHK-Installer.exe" -ArgumentList "/S", "/v", "/qn"

    - name: Download Ahk2Exe
      run: |
        # ä¸‹è½½ Ahk2Exe ç¼–è¯‘å™¨
        $url = "https://www.autohotkey.com/download/ahk2exe.exe"
        curl -L -o Ahk2Exe.exe $url

    - name: Compile AHK script
      run: |
        # ä½¿ç”¨ Ahk2Exe ç¼–è¯‘ï¼ˆå¦‚æœå®‰è£…æˆåŠŸï¼Œç›´æ¥è°ƒç”¨ï¼‰
        # å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨å·²ä¸‹è½½çš„ Ahk2Exe.exe
        .\Ahk2Exe.exe /silent /in "å®æ—¶æ‰“å­—ç¿»è¯‘.ahk" /icon "ICON.ico" /out "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" || echo "Compile may have failed, checking for output..."

    - name: Check compiled file
      run: |
        if (Test-Path "å®æ—¶æ‰“å­—ç¿»è¯‘.exe") {
          Write-Host "âœ… Compilation successful!"
          Get-Item "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "âš ï¸ Compilation failed or exe not found"
          exit 1
        }

    - name: Create distribution package
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "dist"

        # å¤åˆ¶ä¸»ç¨‹åº
        Copy-Item "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" -Destination "dist/"

        # å¤åˆ¶é…ç½®ç¤ºä¾‹
        Copy-Item "config.example.json" -Destination "dist/"

        # å¤åˆ¶ README
        Copy-Item "README.md" -Destination "dist/"

        # å¤åˆ¶å¿…éœ€çš„ DLL æ–‡ä»¶ï¼ˆ64ä½ï¼‰
        New-Item -ItemType Directory -Force -Path "dist/lib"
        Copy-Item -Path "lib/dll_64/*" -Destination "dist/lib/" -Recurse

        # å¤åˆ¶ images æ–‡ä»¶å¤¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (Test-Path "images") {
          Copy-Item -Path "images/*" -Destination "dist/" -Recurse
        }

        # åˆ—å‡ºæ‰“åŒ…å†…å®¹
        Write-Host "ğŸ“¦ Package contents:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Create ZIP archive
      run: |
        # åˆ›å»ºå‘å¸ƒç”¨çš„ ZIP æ–‡ä»¶
        Compress-Archive -Path "dist/*" -DestinationPath "Real-time-translation-typing.zip"

        Write-Host "ğŸ“¦ Archive created:"
        Get-Item "Real-time-translation-typing.zip" | Select-Object Name, Length

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing
        path: dist/

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing-zip
        path: Real-time-translation-typing.zip

  # ä»…åœ¨ release æ—¶è‡ªåŠ¨å‘å¸ƒ
  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: Real-time-translation-typing-zip

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: Real-time-translation-typing.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
