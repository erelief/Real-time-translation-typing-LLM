name: Build and Package

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: List all files
      run: |
        # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ä»¥ç¡®è®¤
        Write-Host "ğŸ“ Repository files:"
        Get-ChildItem -Recurse -File | Select-Object Name, Length

    - name: Check for executable
      run: |
        # æ£€æŸ¥exeæ–‡ä»¶ï¼ˆä½¿ç”¨é€šé…ç¬¦å¤„ç†ä¸­æ–‡æ–‡ä»¶åï¼‰
        $exeFiles = Get-ChildItem -Filter "*.exe" -File
        if ($exeFiles) {
          Write-Host "âœ… Found executable files:"
          $exeFiles | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)" }
        } else {
          Write-Host "âš ï¸ No exe files found in repository"
          exit 1
        }

    - name: Create distribution package
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "dist"

        # å¤åˆ¶ä¸»ç¨‹åºï¼ˆä½¿ç”¨é€šé…ç¬¦åŒ¹é…ä¸­æ–‡åç§°ï¼‰
        $mainExe = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" -File
        $mainAhk = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.ahk" -File

        if ($mainExe) {
          Copy-Item $mainExe -Destination "dist/"
          Write-Host "âœ… Copied: $($mainExe.Name)"
        } else {
          Write-Host "âš ï¸ exe file not found"
          exit 1
        }

        if ($mainAhk) {
          Copy-Item $mainAhk -Destination "dist/"
          Write-Host "âœ… Copied: $($mainAhk.Name)"
        } else {
          Write-Host "âš ï¸ ahk file not found"
          exit 1
        }

        # å¤åˆ¶é…ç½®ç¤ºä¾‹
        Copy-Item "config.example.json" -Destination "dist/"

        # å¤åˆ¶ README
        Copy-Item "README.md" -Destination "dist/"

        # å¤åˆ¶å¿…éœ€çš„ lib æ–‡ä»¶
        New-Item -ItemType Directory -Force -Path "dist/lib"
        Copy-Item -Path "lib/*.ahk" -Destination "dist/lib/"
        if (Test-Path "lib/dll_64") {
          New-Item -ItemType Directory -Force -Path "dist/lib/dll_64"
          Copy-Item -Path "lib/dll_64/*" -Destination "dist/lib/dll_64/"
        }

        # åˆ—å‡ºæ‰“åŒ…å†…å®¹
        Write-Host "ğŸ“¦ Package contents:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Create ZIP archive
      run: |
        # åˆ›å»ºå‘å¸ƒç”¨çš„ ZIP æ–‡ä»¶
        Compress-Archive -Path "dist/*" -DestinationPath "Real-time-translation-typing.zip"

        Write-Host "ğŸ“¦ Archive created:"
        Get-Item "Real-time-translation-typing.zip" | Select-Object Name, Length

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing
        path: dist/

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing-zip
        path: Real-time-translation-typing.zip

  # ä»…åœ¨ release æ—¶è‡ªåŠ¨å‘å¸ƒ
  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: Real-time-translation-typing-zip

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: Real-time-translation-typing.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
