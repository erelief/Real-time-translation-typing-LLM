name: Build and Package

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  release:
    types: [created]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: List all files
      run: |
        Write-Host "ğŸ“ Repository files:"
        Get-ChildItem -Recurse -File | Select-Object Name, Length

    - name: Check for executable
      run: |
        # æ£€æŸ¥exeæ–‡ä»¶
        $exeFiles = Get-ChildItem -Filter "*.exe" -File
        if ($exeFiles) {
          Write-Host "âœ… Found executable files:"
          $exeFiles | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)" }
        } else {
          Write-Host "âš ï¸ No exe files found in repository"
          exit 1
        }

    - name: Create distribution package
      run: |
        # 1. åˆ›å»ºå‘å¸ƒæ ¹ç›®å½•
        New-Item -ItemType Directory -Force -Path "dist"

        # 2. å¤åˆ¶ä¸»ç¨‹åº
        $mainExe = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" -File
        $mainAhk = Get-ChildItem -Filter "å®æ—¶æ‰“å­—ç¿»è¯‘.ahk" -File

        if ($mainExe) { Copy-Item $mainExe -Destination "dist/" }
        if ($mainAhk) { Copy-Item $mainAhk -Destination "dist/" }

        # 3. å¤åˆ¶é…ç½®å’Œè¯´æ˜
        Copy-Item "config.example.json" -Destination "dist/config.json"
        Copy-Item "README.md" -Destination "dist/"

        # 4. åˆ›å»º lib ç›®å½•å¹¶å¤åˆ¶ .ahk è„šæœ¬
        New-Item -ItemType Directory -Force -Path "dist\lib"
        Copy-Item -Path "lib\*.ahk" -Destination "dist\lib\" -Force

        # 5. utility æ–‡ä»¶å¤¹å·²åˆ é™¤ï¼ˆLOL åŠŸèƒ½å·²å½’æ¡£ï¼‰
        # ä¸å†å¤åˆ¶ utility æ–‡ä»¶å¤¹

        # 6. å¤åˆ¶ 64bit å’Œ 32bit DLL æ–‡ä»¶å¤¹
        if (Test-Path "lib\64bit") {
            Copy-Item -Path "lib\64bit" -Destination "dist\lib" -Recurse -Force
            Write-Host "âœ… Copied 64bit directory"
        }
        if (Test-Path "lib\32bit") {
            Copy-Item -Path "lib\32bit" -Destination "dist\lib" -Recurse -Force
            Write-Host "âœ… Copied 32bit directory"
        }

        # 7. åˆ—å‡ºæœ€ç»ˆæ‰“åŒ…å†…å®¹ä»¥ä¾›æ£€æŸ¥
        Write-Host "ğŸ“¦ Final Package contents:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Create ZIP archive
      run: |
        # ã€ä¿®æ”¹ç‚¹ã€‘æ–‡ä»¶åå¢åŠ äº† -LLM
        # ä½¿ç”¨ 7zip è¿›è¡Œå‹ç¼©
        7z a -tzip "Real-time-translation-typing-LLM.zip" ".\dist\*" -mx9

        Write-Host "ğŸ“¦ Archive created:"
        Get-Item "Real-time-translation-typing-LLM.zip" | Select-Object Name, Length

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing-LLM # è¿™é‡Œ Artifact åå­—ä¹Ÿé¡ºä¾¿æ”¹å¯¹äº†
        path: dist/

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-pkg
        # ã€ä¿®æ”¹ç‚¹ã€‘è·¯å¾„åŒ¹é…æ–°çš„æ–‡ä»¶å
        path: Real-time-translation-typing-LLM.zip

  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-pkg

    - name: Display Downloaded Files
      run: ls -R

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: |
          **/*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}