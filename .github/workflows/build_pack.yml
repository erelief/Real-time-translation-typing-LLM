name: Build and Package

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  release:
    types: [created]

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for executable
      run: |
        # æ£€æŸ¥å®æ—¶æ‰“å­—ç¿»è¯‘.exeæ˜¯å¦å­˜åœ¨ï¼ˆåº”è¯¥å·²æäº¤åˆ°ä»“åº“ï¼‰
        if (Test-Path "å®æ—¶æ‰“å­—ç¿»è¯‘.exe") {
          Write-Host "âœ… Found å®æ—¶æ‰“å­—ç¿»è¯‘.exe"
          Get-Item "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Host "âš ï¸ å®æ—¶æ‰“å­—ç¿»è¯‘.exe not found in repository"
          Write-Host "Please compile it once using Ahk2Exe and commit to the repository"
          exit 1
        }

    - name: Create distribution package
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "dist"

        # å¤åˆ¶ä¸»ç¨‹åºï¼ˆ.exe å’Œ .ahkï¼‰
        # .exe æ˜¯ç¼–è¯‘å¥½çš„è§£é‡Šå™¨ï¼Œ.ahk æ˜¯æºä»£ç 
        Copy-Item "å®æ—¶æ‰“å­—ç¿»è¯‘.exe" -Destination "dist/"
        Copy-Item "å®æ—¶æ‰“å­—ç¿»è¯‘.ahk" -Destination "dist/"

        # å¤åˆ¶é…ç½®ç¤ºä¾‹
        Copy-Item "config.example.json" -Destination "dist/"

        # å¤åˆ¶ README
        Copy-Item "README.md" -Destination "dist/"

        # å¤åˆ¶å¿…éœ€çš„ lib æ–‡ä»¶
        New-Item -ItemType Directory -Force -Path "dist/lib"
        Copy-Item -Path "lib/*.ahk" -Destination "dist/lib/" -Recurse
        if (Test-Path "lib/dll_64") {
          Copy-Item -Path "lib/dll_64/*" -Destination "dist/lib/dll_64/" -Recurse
        }

        # å¤åˆ¶ images æ–‡ä»¶å¤¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (Test-Path "images") {
          Copy-Item -Path "images/*" -Destination "dist/" -Recurse
        }

        # åˆ—å‡ºæ‰“åŒ…å†…å®¹
        Write-Host "ğŸ“¦ Package contents:"
        Get-ChildItem -Path "dist" -Recurse | Select-Object FullName, Length

    - name: Create ZIP archive
      run: |
        # åˆ›å»ºå‘å¸ƒç”¨çš„ ZIP æ–‡ä»¶
        Compress-Archive -Path "dist/*" -DestinationPath "Real-time-translation-typing.zip"

        Write-Host "ğŸ“¦ Archive created:"
        Get-Item "Real-time-translation-typing.zip" | Select-Object Name, Length

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing
        path: dist/

    - name: Upload ZIP artifact
      uses: actions/upload-artifact@v4
      with:
        name: Real-time-translation-typing-zip
        path: Real-time-translation-typing.zip

  # ä»…åœ¨ release æ—¶è‡ªåŠ¨å‘å¸ƒ
  release:
    needs: build
    runs-on: windows-latest
    if: github.event_name == 'release'
    permissions:
      contents: write

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: Real-time-translation-typing-zip

    - name: Upload release asset
      uses: softprops/action-gh-release@v1
      with:
        files: Real-time-translation-typing.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
